minimum-vagga: v0.6.0

_templates:
  local_env: &local_env
    APP_CONFIG: /config/application.py

containers:
  _base_alpine:
    setup:
    - !Alpine v3.4
    - !EnsureDir /config
    - !Sh "chmod +r /bin/bbsuid"

  redis-dev:
    setup:
    - !Container _base_alpine
    - !Install [redis]
    - !EnsureDir /storage
    volumes:
      /storage: !Persistent
        name: redis
        init-command: _copy-example-db
      /config: !BindRO /work/config/local

  builder:
    setup:
    - !Container _base_alpine
    - !NpmDependencies
      file: package.json
      peer: true
      optional: true
      dev: true

  static:
    setup:
    - !Container builder
    - !EnsureDir /static
    - !Copy
      source: /work/frontend
      path: /tmp/frontend
    - !Copy
      source: /work/webpack.config.js
      path: /tmp/webpack.config.js
    - !Env
      NODE_PATH: /usr/lib/node_modules
      NODE_ENV: production
    - !RunAs
      work-dir: /tmp
      script: webpack --progress --output-path /static
    auto-clean: true

  app-dev:
    setup:
      - !Container _base_alpine
      - !Install [python3]
      - !Py3Requirements requirements.txt
      - !EnsureDir /static
      - !Build
        container: static
        source: /static
        path: /static
    environ: *local_env
    volumes:
      /config: !BindRO /work/config/local

  app-deploy:
    setup:
    - !Container _base_alpine
    - !Install [python3]
    - !Py3Requirements requirements.txt
    - !EnsureDir /static
    - !Build
      container: static
      source: /static
      path: /static
    - !Copy
      source: /work/config/production
      path: /config
    - !EnsureDir /lithos
    - !Copy
      source: /work/lithos/production
      path: /lithos
    - !EnsureDir /app
    - !Copy
      source: /work/twicher
      path: /app
    - !Sh python3 -m compileall /app

  redis-deploy:
    setup:
    - !Container _base_alpine
    - !Install [redis]
    - !EnsureDir /storage
    - !Copy
      source: /work/config/production
      path: /config
    - !EnsureDir /lithos
    - !Copy
      source: /work/lithos/production
      path: /lithos

commands:
  _copy-example-db: !Command
    container: redis
    run: cp examples/dump.rdb /storage/

  _redis: &redis !Command
    container: redis-dev
    run:
    - redis-server
    - /config/redis.conf

  _app: &app !Command
    container: app-dev
    work-dir: twicher
    run:
    - python3
    - application.py

  webpack: !Command
    container: builder
    description: Webpack CLI
    environ:
      NODE_PATH: /usr/lib/node_modules
    run: [webpack]

  run: !Supervise
    description: Run full server stack
    kill-unresponsive-after: 5
    children:
      redis: *redis
      app: *app